<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Section</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>

<div style="display:flex; gap:25px;">

    <!-- LEFT: —É—Ä–æ–∫ -->
    <div style="width:65%;">
        <h1 th:text="${section.course.title}"></h1>

        <h2 th:text="'–£—Ä–æ–∫ ‚Ññ ' + ${section.orderIndex}"></h2>

        <div style="border:1px solid #ccc;padding:15px;border-radius:8px;">
            <div id="lessonContent"></div>

            <script th:inline="javascript">
                const lessonMarkdown = /*[[${section.content}]]*/ "";
                document.getElementById("lessonContent").innerHTML = marked.parse(lessonMarkdown);
            </script>

        </div>

        <br/>

        <div th:if="${completed}">
            <p style="color:green;font-weight:bold;">
                ‚úì –£—Ä–æ–∫ —É–∂–µ –ø—Ä–æ–π–¥–µ–Ω
            </p>
        </div>

        <div th:if="${!completed}">
            <form th:action="@{/courses/sections/{id}/complete(id=${section.id})}"
                  method="post">

                <input type="hidden"
                       th:name="${_csrf.parameterName}"
                       th:value="${_csrf.token}"/>

                <button type="submit">–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–æ–π–¥–µ–Ω–æ</button>
            </form>
        </div>

        <br/>

        <a th:href="@{/courses/{id}(id=${section.course.id})}">
            ‚Üê –ù–∞–∑–∞–¥ –∫ –∫—É—Ä—Å—É
        </a>
    </div>

    <!-- RIGHT: AI CHAT -->
    <div style="width:35%; border-left:1px solid #ddd; padding-left:20px;">
        <h3>AI Assistant</h3>

        <div id="chatBox"
             style="height:400px; overflow-y:auto; border:1px solid #ccc;
                    padding:10px; border-radius:8px; background:#fafafa;
                    display:flex; flex-direction:column; gap:8px;">

            <div th:each="m : ${messages}">

                <!-- USER -->
                <div th:if="${m.role.name() == 'USER'}"
                     style="align-self:flex-end;
                background:#2563eb;
                color:white;
                padding:10px 12px;
                border-radius:12px;
                max-width:75%;
                line-height:1.4;">
                    <b>–í—ã</b><br/>
                    <div th:if="${m.role.name() == 'AI'}"
                         class="ai-message">
                        <b style="color:green;">AI</b><br/>
                        <div th:utext="${#strings.replace(m.content, '\n', '<br/>')}"></div>
                    </div>
                    <div style="font-size:10px; opacity:0.8; margin-top:3px;">
                        üë§ user
                    </div>
                </div>

                <!-- AI -->
                <div th:if="${m.role.name() == 'AI'}"
                     style="align-self:flex-start;
                background:#e9ffe8;
                padding:10px 12px;
                border-radius:12px;
                max-width:75%;
                line-height:1.4;">
                    <b style="color:green;">AI</b><br/>
                    <span th:text="${m.content}"></span>
                    <div style="font-size:10px; opacity:0.7; margin-top:3px;">
                        ü§ñ assistant
                    </div>
                </div>

            </div>

            <p th:if="${#lists.isEmpty(messages)}">
                –ü–æ–∫–∞ –∑–¥–µ—Å—å –ø—É—Å—Ç–æ üòä –ó–∞–¥–∞–π –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å!
            </p>

        </div>

        <script>
            const box = document.getElementById('chatBox');
            if (box) box.scrollTop = box.scrollHeight;
        </script>

        <br/>

        <!-- –§–û–†–ú–ê –î–û–õ–ñ–ù–ê –ë–´–¢–¨ –í–ù–£–¢–†–ò –≠–¢–û–ì–û DIV -->
        <form th:action="@{/courses/sections/{id}/ask(id=${section.id})}"
              method="post">

            <textarea name="question"
                      placeholder="–ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –ø–æ —É—Ä–æ–∫—É..."
                      style="width:100%; height:80px;" required></textarea>

            <input type="hidden"
                   th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}"/>

            <br/><br/>
            <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>

    </div>

</div>

</body>
</html>

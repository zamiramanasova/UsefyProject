<script>
    async function sendMessage(e) {
        e.preventDefault();

        const textarea = document.querySelector("textarea[name='question']");
        const text = textarea.value.trim();
        if (!text) return;

        const box = document.getElementById("chatBox");

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—Ä–∞–∑—É
        box.innerHTML += `
        <div style="margin-bottom:10px;">
            <b style="color:#2b7cff;">–í—ã:</b> ${text}
        </div>
    `;

        textarea.value = "";

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        const typing = document.createElement("div");
        typing.id = "typing";
        typing.innerHTML = `<b style="color:green;">AI:</b> –ø–µ—á–∞—Ç–∞–µ—Ç...`;
        box.appendChild(typing);
        box.scrollTop = box.scrollHeight;

        await fetch(`/api/chat/${sectionId}`, {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: text
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –ø–æ–¥—Ç—è–Ω—É—Ç—å –∏—Å—Ç–æ—Ä–∏—é
        location.reload();
    }
</script>

<script>
    const sectionId = /*[[${section.id}]]*/ 0;
</script>

<body>

<div style="display:flex; gap:25px;">

    <!-- LEFT: Section content -->
    <div style="width:65%;">
        <h1 th:text="${section.course.title}"></h1>

        <h2 th:text="'–£—Ä–æ–∫ ‚Ññ ' + ${section.orderIndex}"></h2>

        <div style="border:1px solid #ccc;padding:15px;border-radius:8px;">
            <pre th:text="${section.content}"></pre>
        </div>

        <br/>

        <div th:if="${completed}">
            <p style="color:green;font-weight:bold;">
                ‚úì –£—Ä–æ–∫ —É–∂–µ –ø—Ä–æ–π–¥–µ–Ω
            </p>
        </div>

        <div th:if="${!completed}">
            <form th:action="@{/courses/sections/{id}/complete(id=${section.id})}"
                  method="post">

                <input type="hidden"
                       th:name="${_csrf.parameterName}"
                       th:value="${_csrf.token}"/>

                <button type="submit">–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–æ–π–¥–µ–Ω–æ</button>
            </form>
        </div>

        <br/>

        <a th:href="@{/courses/{id}(id=${section.course.id})}">
            ‚Üê –ù–∞–∑–∞–¥ –∫ –∫—É—Ä—Å—É
        </a>
    </div>

    <!-- RIGHT: AI Assistant -->
    <div style="width:35%; border-left:1px solid #ddd; padding-left:20px;">
        <h3>AI Assistant</h3>

        <div id="chatBox"
             style="height:400px; overflow-y:auto; border:1px solid #ccc; padding:10px; border-radius:8px; background:#fafafa;">

            <div th:each="m : ${messages}">
                <div th:if="${m.role.name() == 'USER'}" style="margin-bottom:10px;">
                    <b style="color:#2b7cff;">–í—ã:</b>
                    <span th:text="${m.content}"></span>
                </div>

                <div th:if="${m.role.name() == 'AI'}" style="margin-bottom:10px;">
                    <b style="color:green;">AI:</b>
                    <span th:text="${m.content}"></span>
                </div>
            </div>

            <p th:if="${#lists.isEmpty(messages)}">
                –ü–æ–∫–∞ –∑–¥–µ—Å—å –ø—É—Å—Ç–æ üòä –ó–∞–¥–∞–π –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å!
            </p>

        </div>

        <br/>

        <form onsubmit="sendMessage(event)">

        <textarea name="question"
                  placeholder="–ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –ø–æ —É—Ä–æ–∫—É..."
                  style="width:100%; height:80px;" required></textarea>

            <br/><br/>
            <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>
    </div>

    <script>
        const box = document.getElementById('chatBox');
        box.scrollTop = box.scrollHeight;
    </script>

</div>

</body>
